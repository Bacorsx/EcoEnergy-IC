{% extends "base.html" %}
{% block title %}Dashboard · EcoEnergy{% endblock %}
{% block content %}

<div class="grid kpis">
  <section class="card">
    <h3>DISPOSITIVOS POR CATEGORÍA</h3>
    <ul class="list">
      {% for c in counts_by_cat %}
        <li><span>{{ c.name }}</span><span class="badge">{{ c.n }}</span></li>
      {% empty %}<li>Sin categorías</li>{% endfor %}
    </ul>
  </section>

  <section class="card">
    <h3>DISPOSITIVOS POR ZONA</h3>
    <ul class="list">
      {% for z in counts_by_zone %}
        <li><span>{{ z.name }}</span><span class="badge">{{ z.n }}</span></li>
      {% empty %}<li>Sin zonas</li>{% endfor %}
    </ul>
  </section>

  <section class="card">
    <h3>ALERTAS DE LA SEMANA</h3>
    <div class="tags">
      <span class="tag tag-danger">Grave: {{ sev_map.GRAVE }}</span>
      <span class="tag tag-warn">Alto: {{ sev_map.ALTO }}</span>
      <span class="tag tag-muted">Mediano: {{ sev_map.MEDIANO }}</span>
    </div>
  </section>
</div>

<div class="grid halves">
  <section class="card">
    <div class="card-head">
      <h3>ÚLTIMAS 10 MEDICIONES</h3>
      <a href="{% url 'dispositivos:measurement_list' %}">Ver todas</a>
    </div>
    <table class="table">
      <thead>
        <tr><th>Fecha/Hora</th><th>Dispositivo</th><th>Producto</th><th>Valor</th></tr>
      </thead>
      <tbody>
      {% for m in last_measurements %}
        <tr>
          <td>{{ m.measured_at|date:"d/m/Y H:i" }}</td>
          <td>
            {% if m.product and m.product.device %}
              <a href="{% url 'dispositivos:device_detail' m.product.device.pk %}">{{ m.product.device.name }}</a>
            {% else %}
              —
            {% endif %}
          </td>
          <td>{{ m.product.name }}</td>
          <td>{{ m.value }} {{ m.unit }}</td>
        </tr>
      {% empty %}
        <tr><td colspan="4">Sin mediciones</td></tr>
      {% endfor %}
      </tbody>
    </table>
  </section>

  <section class="card">
    <div class="card-head">
      <h3>ALERTAS RECIENTES</h3>
      <a href="{% url 'dispositivos:alert_list' %}">Ver todas</a>
    </div>
    <ul class="alerts">
      {% for m in recent_alerts_ms %}
        <li>
          <div class="row">
            <span class="pill {% if m.product_alert.alert.severity == 'GRAVE' %}danger{% elif m.product_alert.alert.severity == 'ALTO' %}warn{% else %}muted{% endif %}">
              {{ m.product_alert.alert.get_severity_display }}
            </span>
            <span class="muted">{{ m.created_at|date:"d/m/Y H:i" }}</span>
          </div>
          <div>
            {% if m.product_alert.product.device %}
              <a href="{% url 'dispositivos:device_detail' m.product_alert.product.device.pk %}">
                {{ m.product_alert.product.device.name }}
              </a>
            {% else %}—{% endif %}
            · {{ m.product_alert.product.name }} · {{ m.measurement.value }} {{ m.measurement.unit }}
          </div>
        </li>
      {% empty %}
        <li>Sin alertas</li>
      {% endfor %}
    </ul>
  </section>
</div>

<section class="card">
  <div class="card-head">
    <h3>DISPOSITIVOS</h3>
    <a href="{% url 'dispositivos:device_list' %}">Ir a listado</a>
  </div>

  <form method="get" class="filters">
    <label>Categoría</label>
    <select name="category">
      <option value="">Todas</option>
      {% for c in categories %}
        <option value="{{ c.id }}" {% if cat_selected|stringformat:"s" == c.id|stringformat:"s" %}selected{% endif %}>{{ c.name }}</option>
      {% endfor %}
    </select>
    <label>Zona</label>
    <select name="zone">
      <option value="">Todas</option>
      {% for z in zones %}
        <option value="{{ z.id }}" {% if zone_selected|stringformat:"s" == z.id|stringformat:"s" %}selected{% endif %}>{{ z.name }}</option>
      {% endfor %}
    </select>
    <button class="btn btn-dark" type="submit">Aplicar filtros</button>
  </form>

  <div class="cards">
    {% for d in device_cards %}
      <article class="device-card">
        <a href="{% url 'dispositivos:device_detail' d.pk %}" class="name">{{ d.name }}</a>
        <div class="meta">{{ d.zone.name }}</div>
      </article>
    {% empty %}
      <div class="muted">No hay dispositivos con estos filtros.</div>
    {% endfor %}
  </div>
</section>

{% endblock %}
